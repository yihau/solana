name: Dependabot PR

on:
  pull_request:
    branches:
      - master

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: github.triggering_actor == 'yihau'
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.PAT }}

      - name: update code
        run: |
          input=${{ github.event.pull_request.title }}

          regex="[Bb]ump (.*) from (.*) to (.*)"
          if [[ ! "$input" =~ $regex ]]; then
            echo "unexpected pattern"
            exit 1
          fi

          crate_name="${BASH_REMATCH[1]}"
          old_version="${BASH_REMATCH[2]}"
          new_version="${BASH_REMATCH[3]}"
          echo "crate_name: $crate_name, old_version: $old_version, new_version: $new_version"

          ./scripts/cargo-for-all-lock-files.sh -- update -p $crate_name:$old_version --precise $new_version
          ./scripts/cargo-for-all-lock-files.sh -- tree

      - name: push
        run: |
          git add **/Cargo.toml **/Cargo.lock
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git commit -am "update all Cargo lock files"
          git push
